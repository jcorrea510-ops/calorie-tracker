<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Calorie Tracker</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Meta tag for theme color for mobile browsers -->
    <meta name="theme-color" content="#1a202c">
    <style>
        /* Dark Mode Styles - Deep, consistent dark theme */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c; /* Deep dark background */
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 1rem;
        }
        #app-container {
            background-color: #2d3748; /* Main container background, a muted dark blue-gray */
            border-radius: 1.5rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4); /* Prominent dark shadow */
            max-width: 480px;
            width: 100%;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            margin-top: 2rem;
            margin-bottom: 2rem;
        }
        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #e2e8f0; /* Light text for titles */
            margin-bottom: 1rem;
        }
        input[type="number"],
        input[type="text"] {
            border-radius: 0.75rem;
            padding: 0.75rem 1rem;
            border: 1px solid #4a5568; /* Darker border for inputs */
            font-size: 1rem;
            background-color: #2D3748 !important; /* Explicitly set input background to dark, with !important */
            color: #e2e8f0; /* Light text for inputs */
            outline: none; /* Remove default outline */
            flex-grow: 1; /* Allow inputs to grow */
            box-shadow: none; /* Ensure no accidental light box shadow */
            -webkit-appearance: none; /* For iOS Safari */
            -moz-appearance: none; /* For Firefox */
            appearance: none; /* Standard property */
        }
        input[type="number"]:focus,
        input[type="text"]:focus {
            border-color: #667eea; /* Highlight border on focus */
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.5); /* Subtle glow on focus */
        }
        input[type="number"]::placeholder,
        input[type="text"]::placeholder {
            color: #a0aec0; /* Lighter placeholder text */
        }
        button {
            border-radius: 0.75rem;
            padding: 0.75rem 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out, box-shadow 0.2s ease-in-out;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3); /* Enhanced shadow for buttons */
        }
        button:hover {
            transform: translateY(-2px); /* More pronounced lift on hover */
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4); /* Deeper shadow on hover */
        }
        button:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2); /* Smaller shadow on click */
        }
        /* Primary button */
        #addManualFoodBtn, #searchFoodBtn, #saveSettingsBtn, #addManualCardioBtn, #searchCardioBtn, #addCustomPresetFoodBtn, #addGramsEntryBtn {
            background-color: #667eea; /* Vibrant Indigo primary button */
            color: white;
        }
        #addManualFoodBtn:hover, #searchFoodBtn:hover, #saveSettingsBtn:hover, #addManualCardioBtn:hover, #searchCardioBtn:hover, #addCustomPresetFoodBtn:hover, #addGramsEntryBtn:hover {
            background-color: #5a67d8; /* Darker indigo on hover */
        }
        /* Secondary button (Set Goals) */
        .secondary-button {
            background-color: #4a5568; /* Dark gray secondary button */
            color: #e2e8f0; /* Light text */
        }
        .secondary-button:hover {
            background-color: #3b4558; /* Darker gray on hover */
        }

        /* Progress Bars */
        .progress-bar-container {
            background-color: #4a5568; /* Darker gray for progress container */
            border-radius: 0.75rem;
            height: 1rem;
            overflow: hidden;
            margin-top: 0.5rem;
        }
        .progress-bar-fill {
            height: 100%;
            background-color: #48bb78; /* Green fill */
            width: 0%;
            border-radius: 0.75rem;
            transition: width 0.5s ease-in-out;
        }
        .progress-bar-fill.warning {
            background-color: #ecc94b; /* Yellow for approaching goal */
        }
        .progress-bar-fill.exceeded {
            background-color: #f56565; /* Red for exceeding goal */
        }

        /* Section Backgrounds - unified dark tones */
        /* Overriding specific Tailwind classes to ensure deep dark colors */
        .bg-indigo-50 { /* Summary Section */
            background-color: #3b4558 !important; /* A darker, richer blue-gray for summary */
        }
        .text-indigo-800, .text-indigo-700 { /* Text colors for summary */
            color: #a7b7e8 !important; /* Lighter, soft indigo text */
        }
        .text-gray-600 { /* General descriptive text */
            color: #cbd5e0 !important; /* Lighter gray text */
        }
        .text-gray-800 { /* Main headings and important text */
            color: #e2e8f0 !important; /* Lightest gray text */
        }
        /* Make 'Add Food' section stand out more */
        .bg-gray-50 { /* This is the Add Food Section */
            background-color: #3b4558 !important; /* Same as summary for consistency, but with stronger shadow */
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.6) !important; /* Stronger shadow */
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.8); /* Darker, more opaque overlay */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        .modal-overlay.open {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: #2d3748; /* Modal background same as app container */
            border-radius: 1.5rem;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6); /* Even deeper shadow for modals */
            max-width: 400px;
            width: 90%;
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
            opacity: 0; /* Start hidden for smooth fade-in */
            transform: scale(0.9); /* Start slightly smaller for pop-in effect */
            max-height: 80vh; /* Limit modal height */
            overflow-y: auto; /* Enable scrolling for long content */
        }
        .modal-overlay.open .modal-content {
            opacity: 1;
            transform: scale(1); /* Scale to normal size */
        }
        .close-button {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #a0aec0; /* Lighter close button */
        }
        .close-button:hover {
            color: #cbd5e0;
        }

        /* Message Box - Styling kept, but no JS calls to show it */
        .message-box {
            background-color: #2d3748; /* Dark background */
            color: #e2e8f0; /* Light text */
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            border: 1px solid #4a5568; /* Darker border */
            position: fixed; /* Keeping fixed positioning */
            bottom: 1rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1001;
            opacity: 0; /* Hidden by default */
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
            min-width: 250px;
            text-align: center;
            padding: 1rem;
            border-radius: 0.75rem;
        }
        /* Specific message box types (colors adjusted for dark mode) */
        .message-box.bg-red-100 { background-color: #a72d2d !important; color: white !important; border-color: #7b2020 !important; } /* Darker red */
        .message-box.bg-green-100 { background-color: #2c8c5c !important; color: white !important; border-color: #206d45 !important; } /* Darker green */
        .message-box.bg-blue-100 { background-color: #2671ad !important; color: white !important; border-color: #1b5280 !important; } /* Darker blue */


        /* Loading Spinner */
        .loading-overlay {
            background-color: rgba(0, 0, 0, 0.7); /* Darker overlay */
        }
        .spinner {
            border-top: 4px solid #667eea; /* Lighter indigo spinner */
        }

        /* Crucial fixes for search input group */
        .search-input-group {
            display: flex;
            flex-direction: column; /* Always stack vertically */
            gap: 0.75rem; /* Gap between elements */
            width: 100%; /* Ensure it takes full width of its parent */
            box-sizing: border-box; /* Include padding and border in the element's total width */
            align-items: stretch; /* Make children stretch to fill container height */
        }
        /* Media query for wider screens to arrange inputs in a row */
        @media (min-width: 640px) {
            .search-input-group-row {
                flex-direction: row; /* Arrange children in a row */
                align-items: center; /* Vertically align items */
            }
            .search-input-group-row input[type="text"] {
                flex-grow: 2; /* Allow text input to take more space */
            }
            .search-input-group-row input[type="number"] {
                flex-grow: 0.5; /* Quantity input can be smaller */
                max-width: 80px; /* Constrain width for quantity */
            }
        }

        /* Manual entry specific grid adjustments */
        .manual-entry-grid {
            display: grid;
            grid-template-columns: 1fr; /* Stack on small screens */
            gap: 0.75rem;
        }
        @media (min-width: 640px) {
            .manual-entry-grid {
                grid-template-columns: 1fr 1fr 0.5fr; /* Calories, Protein, Quantity on larger screens */
            }
        }
        /* New styles for the sub-sections within "Add Data" */
        .sub-section-card {
            background-color: #3b4558; /* Same as the main "Add Data" div for consistency */
            border-radius: 1rem; /* Slightly smaller border-radius than parent */
            padding: 1.25rem;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5); /* Deeper shadow for distinction */
            margin-bottom: 1.5rem; /* Space between sub-sections */
        }
        /* Remove bottom margin from the last sub-section card */
        .sub-section-card:last-child {
            margin-bottom: 0;
        }

        /* Custom Dropdown Styles */
        .custom-dropdown-container {
            position: relative;
            width: 100%;
            margin-bottom: 1rem; /* Space between dropdown and manual fields */
            z-index: 10; /* Ensure dropdown appears above other elements */
        }
        .custom-dropdown-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            border-radius: 0.75rem;
            border: 1px solid #4a5568;
            background-color: #2D3748;
            color: #e2e8f0;
            cursor: pointer;
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .custom-dropdown-header:hover {
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.5);
        }
        .dropdown-arrow {
            font-size: 0.8rem;
            margin-left: 0.5rem;
            transition: transform 0.2s ease-in-out;
        }
        .custom-dropdown-header.open .dropdown-arrow {
            transform: rotate(180deg);
        }
        .custom-dropdown-options {
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
            background-color: #2d3748;
            border: 1px solid #4a5568;
            border-radius: 0.75rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
            z-index: 100;
        }
        .custom-dropdown-item {
            padding: 0.75rem 1rem;
            color: #e2e8f0;
            cursor: pointer;
            transition: background-color 0.1s ease-in-out;
        }
        .custom-dropdown-item:hover {
            background-color: #4a5568;
        }
        /* Ensure specific hidden/visible states are handled correctly */
        .hidden {
            display: none !important;
        }
    </style>
    <!-- Firebase SDK CDN -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, addDoc, onSnapshot, collection, query, where, serverTimestamp, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables for Firebase instances
        let app;
        let db;
        let auth;
        let userId = 'anonymous'; // Default to anonymous until authenticated
        let appId; // Now declared globally
        let currentProteinGoal = 0;
        let currentCalorieGoal = 0;
        let currentWeight = 0; // New: User's weight
        let totalProteinConsumed = 0; // Track total protein consumed
        let totalCaloriesConsumed = 0; // Track total calories consumed
        let totalDistance = 0; // New: Total distance for cardio
        let totalCaloriesBurned = 0; // New: Total calories burned for cardio

        let isUiReady = false; // Flag to ensure UI elements are ready
        let unsubscribeFoodListener = null; // To hold the unsubscribe function for food entries listener
        let unsubscribeCardioListener = null; // New: To hold the unsubscribe function for cardio entries listener
        let unsubscribePresetFoodsListener = null; // New: To hold the unsubscribe for preset foods

        // Nutritionix API Keys (REPLACE WITH YOUR OWN!)
        // WARNING: Directly exposing API keys in client-side code is NOT secure for production.
        // For public/production apps, consider using a backend proxy server to protect your keys.
        const NUTRITIONIX_APP_ID = "75b7c31e"; // User's provided App ID
        const NUTRITIONIX_APP_KEY = "6d62a69715291408ea8bcb6815272fd1"; // User's provided App Key


        // UI Elements (declared globally, assigned in window.onload)
        let proteinGoalDisplay;
        let calorieGoalDisplay;
        let currentProteinDisplay;
        let currentCalorieDisplay;
        let proteinLeftDisplay;
        let caloriesLeftDisplay;
        let proteinProgressBarFill;
        let calorieProgressBarFill;
        let manualCaloriesInput;
        let manualProteinInput;
        let manualQuantityInput;
        let searchFoodNameInput;
        let searchFoodQuantityInput; // New: Quantity input for food search
        // New Cardio UI Elements
        let currentDistanceDisplay;
        let currentCaloriesBurnedDisplay;
        let manualCardioDistanceInput;
        let manualCardioCaloriesBurnedInput;
        let searchCardioInput; // Combined search input for cardio

        let settingsModal;
        let settingsProteinGoalInput;
        let settingsCalorieGoalInput;
        let settingsWeightInput; // New weight input in settings
        let loadingOverlay;
        let messageBox;

        // New UI elements for preset foods
        let presetDropdownHeader;
        let presetDropdownOptions;
        let selectedPresetFoodNameDisplay;
        let customPresetFoodInputs;
        let customPresetCaloriesInput;
        let customPresetProteinInput;
        let customPresetServingSizeInput;
        let addCustomPresetFoodBtn;
        let toggleCustomFoodInputBtn; // New button to toggle custom food input visibility

        // New UI elements for quantity input modal
        let quantityInputModal;
        let quantityInputGrams;
        let addGramsEntryBtn;
        let selectedPresetFood = null; // To store the food selected from the dropdown


        // Function to show/hide loading spinner
        function showLoading(show) {
            if (!loadingOverlay) return;
            if (show) {
                loadingOverlay.classList.add('show');
            } else {
                loadingOverlay.classList.remove('show');
            }
        }

        /**
         * Evaluates a mathematical expression string and returns the result.
         * Basic validation for safety.
         * @param {string} expression - The mathematical expression to evaluate.
         * @returns {number | null} The result of the evaluation, or null if invalid.
         */
        function evaluateMathExpression(expression) {
            // Remove any whitespace
            expression = String(expression).replace(/\s+/g, '');

            // Basic validation to prevent arbitrary code execution (e.g., "1 + 1; alert('hi')")
            // This regex allows numbers, decimals, basic operators (+, -, *, /), and parentheses.
            // It does NOT allow function calls, semicolons, letters, etc.
            const safeExpressionRegex = /^[0-9+\-*/().]+$/;

            if (!safeExpressionRegex.test(expression)) {
                console.error("Invalid characters in expression:", expression);
                return null;
            }

            try {
                // Using eval() with careful input validation for simple math is generally acceptable
                // in client-side personal tools, but should be avoided for complex/public apps.
                const result = eval(expression);
                if (typeof result === 'number' && isFinite(result)) {
                    return result;
                }
                return null;
            } catch (e) {
                console.error("Error evaluating expression:", expression, e);
                return null;
            }
        }


        // Helper function to get the start of the current "calorie day" (3 AM UTC)
        function getStartOfCalorieDayUTC() {
            const now = new Date();
            const year = now.getUTCFullYear();
            const month = now.getUTCMonth();
            const date = now.getUTCDate();
            const hours = now.getUTCHours();

            let startOfToday3AMUTC = new Date(Date.UTC(year, month, date, 3, 0, 0, 0));

            // If current UTC time is before 3 AM UTC, the calorie day started yesterday at 3 AM UTC
            if (hours < 3) {
                startOfToday3AMUTC.setUTCDate(startOfToday3AMUTC.getUTCDate() - 1);
            }
            return startOfToday3AMUTC;
        }

        // Function to reset daily totals by deleting records in Firestore
        async function resetDailyTotalsInFirestore() {
            if (!db || !appId || !userId) {
                console.warn("Firestore db, appId, or userId not initialized. Cannot reset data.");
                return;
            }
            showLoading(true);
            try {
                const startOfCalorieDay = getStartOfCalorieDayUTC();
                const endOfCalorieDay = new Date(startOfCalorieDay.getTime() + 24 * 60 * 60 * 1000 - 1);

                // --- Delete Food Entries ---
                const foodEntriesCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/foodEntries`);
                const foodQuery = query(foodEntriesCollectionRef,
                    where("timestamp", ">=", startOfCalorieDay),
                    where("timestamp", "<=", endOfCalorieDay)
                );
                const foodSnapshot = await getDocs(foodQuery);
                const foodDeletePromises = [];
                foodSnapshot.forEach((doc) => foodDeletePromises.push(deleteDoc(doc.ref)));
                await Promise.all(foodDeletePromises);
                console.log(`Successfully deleted ${foodSnapshot.size} food entries for the current day.`);

                // --- Delete Cardio Entries ---
                const cardioEntriesCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/cardioEntries`);
                const cardioQuery = query(cardioEntriesCollectionRef,
                    where("timestamp", ">=", startOfCalorieDay),
                    where("timestamp", "<=", endOfCalorieDay)
                );
                const cardioSnapshot = await getDocs(cardioQuery);
                const cardioDeletePromises = [];
                cardioSnapshot.forEach((doc) => cardioDeletePromises.push(deleteDoc(doc.ref)));
                await Promise.all(cardioDeletePromises);
                console.log(`Successfully deleted ${cardioSnapshot.size} cardio entries for the current day.`);

                // Manually reset UI and re-fetch (listeners will pick up empty collections)
                totalProteinConsumed = 0;
                totalCaloriesConsumed = 0;
                totalDistance = 0;
                totalCaloriesBurned = 0;
                updateSummaryDisplay();
                console.log("All daily data reset successfully in UI.");

            } catch (error) {
                console.error("Error resetting daily totals in Firestore:", error);
            } finally {
                showLoading(false);
            }
        }


        // Initialize Firebase and UI elements
        window.onload = async () => {
            // Assign UI elements AFTER DOM is loaded
            proteinGoalDisplay = document.getElementById('proteinGoalDisplay');
            calorieGoalDisplay = document.getElementById('calorieGoalDisplay');
            currentProteinDisplay = document.getElementById('currentProteinDisplay');
            currentCalorieDisplay = document.getElementById('currentCalorieDisplay');
            proteinLeftDisplay = document.getElementById('proteinLeftDisplay');
            caloriesLeftDisplay = document.getElementById('caloriesLeftDisplay');
            proteinProgressBarFill = document.getElementById('proteinProgressBar');
            calorieProgressBarFill = document.getElementById('calorieProgressBar');
            manualCaloriesInput = document.getElementById('manualCalories');
            manualProteinInput = document.getElementById('manualProtein');
            manualQuantityInput = document.getElementById('manualQuantity');
            searchFoodNameInput = document.getElementById('searchFoodName');
            searchFoodQuantityInput = document.getElementById('searchFoodQuantity');
            // New Cardio UI Elements assignments
            currentDistanceDisplay = document.getElementById('currentDistanceDisplay');
            currentCaloriesBurnedDisplay = document.getElementById('currentCaloriesBurnedDisplay');
            manualCardioDistanceInput = document.getElementById('manualCardioDistance');
            manualCardioCaloriesBurnedInput = document.getElementById('manualCardioCaloriesBurned');
            searchCardioInput = document.getElementById('searchCardio');

            settingsModal = document.getElementById('settingsModal');
            settingsProteinGoalInput = document.getElementById('settingsProteinGoal');
            settingsCalorieGoalInput = document.getElementById('settingsCalorieGoal');
            settingsWeightInput = document.getElementById('settingsWeight');
            loadingOverlay = document.getElementById('loadingOverlay');
            messageBox = document.getElementById('messageBox');

            // Assign new preset food UI elements
            presetDropdownHeader = document.getElementById('presetDropdownHeader');
            presetDropdownOptions = document.getElementById('presetDropdownOptions');
            selectedPresetFoodNameDisplay = document.getElementById('selectedPresetFoodName');
            customPresetFoodInputs = document.getElementById('customPresetFoodInputs');
            customPresetCaloriesInput = document.getElementById('customPresetCalories');
            customPresetProteinInput = document.getElementById('customPresetProtein');
            customPresetServingSizeInput = document.getElementById('customPresetServingSize');
            addCustomPresetFoodBtn = document.getElementById('addCustomPresetFoodBtn');
            toggleCustomFoodInputBtn = document.getElementById('toggleCustomFoodInputBtn');


            // Assign new quantity input modal UI elements
            quantityInputModal = document.getElementById('quantityInputModal');
            quantityInputGrams = document.getElementById('quantityInputGrams');
            addGramsEntryBtn = document.getElementById('addGramsEntryBtn');

            // Add event listeners here after elements are assigned
            document.getElementById('addManualFoodBtn').addEventListener('click', addManualFoodEntry);
            document.getElementById('searchFoodBtn').addEventListener('click', searchFoodAndAutoAddMacros);
            document.getElementById('openSettingsBtn').addEventListener('click', openSettingsModal);
            document.getElementById('closeSettingsBtn').addEventListener('click', closeSettingsModal);
            document.getElementById('resetDailyBtn').addEventListener('click', resetDailyTotalsInFirestore);
            // New Cardio Event Listeners
            document.getElementById('addManualCardioBtn').addEventListener('click', addManualCardioEntry);
            document.getElementById('searchCardioBtn').addEventListener('click', searchCardioAndAutoAddMetrics);

            // New Preset Food Event Listeners
            presetDropdownHeader.addEventListener('click', togglePresetDropdown);
            // Options themselves will have click listeners added dynamically in populatePresetFoodDropdown
            addCustomPresetFoodBtn.addEventListener('click', addCustomPresetFood);
            toggleCustomFoodInputBtn.addEventListener('click', toggleCustomFoodInput); // New event listener
            document.getElementById('closeQuantityModalBtn').addEventListener('click', closeQuantityModal);
            addGramsEntryBtn.addEventListener('click', addGramsEntry);

            // Close dropdown if clicked outside
            document.addEventListener('click', (event) => {
                const dropdownContainer = document.querySelector('.custom-dropdown-container');
                if (dropdownContainer && !dropdownContainer.contains(event.target)) {
                    presetDropdownOptions.classList.add('hidden');
                    presetDropdownHeader.classList.remove('open');
                }
            });


            if (settingsModal) {
                settingsModal.addEventListener('click', (e) => {
                    if (e.target === settingsModal) {
                        closeSettingsModal();
                    }
                });
            }
            if (quantityInputModal) {
                quantityInputModal.addEventListener('click', (e) => {
                    if (e.target === quantityInputModal) {
                        closeQuantityModal();
                    }
                });
            }
            document.getElementById('saveSettingsBtn').addEventListener('click', saveSettings);

            // Set UI ready flag *after* all elements are assigned
            isUiReady = true;

            // --- Firebase Initialization with your provided config ---
            // Your web app's Firebase configuration
            const firebaseConfig = {
                apiKey: "AIzaSyBWfl0ygLwWAjLy1f-9hZa5w6CE66YY-40",
                authDomain: "calorie-tracker-10dc5.firebaseapp.com",
                projectId: "calorie-tracker-10dc5",
                storageBucket: "calorie-tracker-10dc5.appspot.com",
                appId: "1:980712360641:web:5ec3e7b33dcab547556240",
                messagingSenderId: "980712360641",
                measurementId: "G-G59S80WVVD"
            };

            // Assign the global appId
            appId = firebaseConfig.projectId;

            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Authenticated with user ID:", userId);
                        listenForGoals();
                        listenForFoodEntries();
                        listenForCardioEntries();
                        listenForPresetFoods(); // Start listening for preset foods
                    } else {
                        try {
                            await signInAnonymously(auth);
                            console.log("Signed in anonymously (GitHub Pages).");
                        } catch (error) {
                            console.error("Firebase authentication error during anonymous sign-in:", error);
                            currentProteinGoal = 100;
                            currentCalorieGoal = 2000;
                            currentWeight = 150; // Default weight if auth fails
                            updateSummaryDisplay();
                            console.warn("Data persistence will not work due to authentication error. Check Firebase project settings (Authentication > Sign-in method > Anonymous).");
                        }
                    }
                });
            } catch (e) {
                console.error("Firebase initialization failed with your provided config:", e);
                console.warn("Data persistence will not work. Check your Firebase config and network connection.");
                currentProteinGoal = 100;
                currentCalorieGoal = 2000;
                currentWeight = 150; // Default weight if init fails
                updateSummaryDisplay();
            }
        };

        // --- Firestore Listeners ---

        function listenForGoals() {
            if (!db || !appId || !userId) {
                console.warn("Firestore db, appId, or userId not initialized. Cannot listen for goals.");
                return;
            }
            const goalsDocRef = doc(db, `artifacts/${appId}/users/${userId}/goals/daily`);
            onSnapshot(goalsDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    currentProteinGoal = data.proteinGoal || 0;
                    currentCalorieGoal = data.calorieGoal || 0;
                    currentWeight = data.weight || 0; // New: Retrieve weight
                    updateSummaryDisplay();
                    console.log("Goals updated:", data);
                } else {
                    // Set default goals and weight if none exist
                    currentProteinGoal = 100;
                    currentCalorieGoal = 2000;
                    currentWeight = 150; // Default weight
                    if (db) {
                        setDoc(goalsDocRef, { proteinGoal: currentProteinGoal, calorieGoal: currentCalorieGoal, weight: currentWeight })
                            .then(() => console.log("Default goals and weight set."))
                            .catch(error => console.error("Error setting default goals and weight:", error));
                    }
                }
            }, (error) => {
                console.error("Error listening to goals:", error);
            });
        }

        function listenForFoodEntries() {
            if (!db || !appId || !userId) {
                console.warn("Firestore db, appId, or userId not initialized. Cannot listen for food entries.");
                return;
            }
            // Unsubscribe from previous listener if it exists to prevent multiple listeners
            if (unsubscribeFoodListener) {
                unsubscribeFoodListener();
                console.log("Unsubscribed from previous food entries listener.");
            }

            const foodEntriesCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/foodEntries`);

            const startOfCalorieDay = getStartOfCalorieDayUTC();
            const endOfCalorieDay = new Date(startOfCalorieDay.getTime() + 24 * 60 * 60 * 1000 - 1);

            const q = query(foodEntriesCollectionRef,
                where("timestamp", ">=", startOfCalorieDay),
                where("timestamp", "<=", endOfCalorieDay)
            );

            // Assign the new unsubscribe function
            unsubscribeFoodListener = onSnapshot(q, (snapshot) => {
                totalProteinConsumed = 0;
                totalCaloriesConsumed = 0;

                snapshot.forEach((doc) => {
                    const entry = doc.data();
                    totalProteinConsumed += entry.protein;
                    totalCaloriesConsumed += entry.calories;
                });

                currentProteinDisplay.textContent = totalProteinConsumed.toFixed(0);
                currentCalorieDisplay.textContent = totalCaloriesConsumed.toFixed(0);

                updateSummaryDisplay();
                console.log("Food entries updated. Total Protein:", totalProteinConsumed, "Total Calories:", totalCaloriesConsumed);
            }, (error) => {
                console.error("Error listening to food entries:", error);
            });
        }

        // New function: Listen for cardio entries
        function listenForCardioEntries() {
            if (!db || !appId || !userId) {
                console.warn("Firestore db, appId, or userId not initialized. Cannot listen for cardio entries.");
                return;
            }
            // Unsubscribe from previous listener if it exists
            if (unsubscribeCardioListener) {
                unsubscribeCardioListener();
                console.log("Unsubscribed from previous cardio entries listener.");
            }

            const cardioEntriesCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/cardioEntries`);

            const startOfCalorieDay = getStartOfCalorieDayUTC();
            const endOfCalorieDay = new Date(startOfCalorieDay.getTime() + 24 * 60 * 60 * 1000 - 1);

            const q = query(cardioEntriesCollectionRef,
                where("timestamp", ">=", startOfCalorieDay),
                where("timestamp", "<=", endOfCalorieDay)
            );

            unsubscribeCardioListener = onSnapshot(q, (snapshot) => {
                totalDistance = 0;
                totalCaloriesBurned = 0;

                snapshot.forEach((doc) => {
                    const entry = doc.data();
                    totalDistance += entry.distance;
                    totalCaloriesBurned += entry.caloriesBurned;
                });

                currentDistanceDisplay.textContent = totalDistance.toFixed(1); // Display distance with 1 decimal
                currentCaloriesBurnedDisplay.textContent = totalCaloriesBurned.toFixed(0); // Display calories burned

                updateSummaryDisplay();
                console.log("Cardio entries updated. Total Distance:", totalDistance, "Total Calories Burned:", totalCaloriesBurned);
            }, (error) => {
                console.error("Error listening to cardio entries:", error);
            });
        }

        // New function: Listen for preset foods
        function listenForPresetFoods() {
            if (!db || !appId || !userId) {
                console.warn("Firestore db, appId, or userId not initialized. Cannot listen for preset foods.");
                return;
            }
            if (unsubscribePresetFoodsListener) {
                unsubscribePresetFoodsListener();
                console.log("Unsubscribed from previous preset foods listener.");
            }

            const presetFoodsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/presetFoods`);
            unsubscribePresetFoodsListener = onSnapshot(presetFoodsCollectionRef, (snapshot) => {
                const foods = [];
                snapshot.forEach((doc) => {
                    foods.push({ id: doc.id, ...doc.data() });
                });
                populatePresetFoodDropdown(foods);
                console.log("Preset foods updated:", foods);
            }, (error) => {
                console.error("Error listening to preset foods:", error);
            });
        }

        function populatePresetFoodDropdown(foods) {
            presetDropdownOptions.innerHTML = ''; // Clear existing options
            if (foods.length === 0) {
                const noFoodItem = document.createElement('div');
                noFoodItem.classList.add('custom-dropdown-item');
                noFoodItem.textContent = 'No preset foods yet. Add custom!';
                noFoodItem.style.pointerEvents = 'none'; // Make it unclickable
                noFoodItem.style.opacity = '0.7';
                presetDropdownOptions.appendChild(noFoodItem);
            } else {
                foods.forEach(food => {
                    const item = document.createElement('div');
                    item.classList.add('custom-dropdown-item');
                    item.textContent = food.name;
                    item.dataset.food = JSON.stringify(food); // Store full food object
                    item.addEventListener('click', handlePresetFoodItemClick);
                    presetDropdownOptions.appendChild(item);
                });
            }
            // Reset header display when dropdown is repopulated
            selectedPresetFoodNameDisplay.textContent = '-- Select Preset Food --';
        }

        // --- UI Update Functions ---

        function updateSummaryDisplay() {
            if (!isUiReady || !proteinProgressBarFill || !calorieProgressBarFill) {
                console.warn("UI elements (progress bars) not ready for summary display update.");
                return;
            }

            proteinGoalDisplay.textContent = currentProteinGoal.toFixed(0);
            calorieGoalDisplay.textContent = currentCalorieGoal.toFixed(0);

            const proteinLeft = currentProteinGoal - totalProteinConsumed;
            const caloriesLeft = currentCalorieGoal - totalCaloriesConsumed;

            proteinLeftDisplay.textContent = proteinLeft.toFixed(0);
            caloriesLeftDisplay.textContent = caloriesLeft.toFixed(0);

            updateProgressBar(proteinProgressBarFill, totalProteinConsumed, currentProteinGoal);
            updateProgressBar(calorieProgressBarFill, totalCaloriesConsumed, currentCalorieGoal);
        }

        function updateProgressBar(fillElement, current, goal) {
            if (!fillElement) {
                console.warn("Progress bar fill element is null or undefined.");
                return;
            }

            let percentage = (goal > 0) ? (current / goal) * 100 : 0;
            const visualPercentage = Math.min(percentage, 100);

            fillElement.style.width = `${visualPercentage}%`;

            fillElement.classList.remove('warning', 'exceeded');
            if (current > goal) {
                fillElement.classList.add('exceeded');
            } else if (current > goal * 0.8) {
                fillElement.classList.add('warning');
            }
        }

        // --- Event Handlers ---

        async function addManualFoodEntry() {
            const calories = parseFloat(manualCaloriesInput.value) || 0;
            const protein = parseFloat(manualProteinInput.value) || 0;
            const quantity = evaluateMathExpression(manualQuantityInput.value);

            if (quantity === null || isNaN(calories) || calories < 0 || quantity <= 0 || isNaN(protein) || protein < 0) {
                 console.error('Validation Error: Calories and Protein must be non-negative numbers. Quantity must be a positive number or valid math expression.');
                 return;
            }

            const finalCalories = calories * quantity;
            const finalProtein = protein * quantity;

            if (!db || !appId || !userId) {
                console.warn("Firestore db, appId, or userId not initialized. Cannot add manual entry. Adding to local totals only.");
                totalProteinConsumed += finalProtein;
                totalCaloriesConsumed += finalCalories;
                updateSummaryDisplay();
                manualCaloriesInput.value = '';
                manualProteinInput.value = '';
                manualQuantityInput.value = '';
                return;
            }

            try {
                showLoading(true);
                await addDoc(collection(db, `artifacts/${appId}/users/${userId}/foodEntries`), {
                    name: `Manual Entry (${manualQuantityInput.value} = ${quantity.toFixed(2)}x)`, // Show raw and evaluated quantity
                    protein: finalProtein,
                    calories: finalCalories,
                    timestamp: serverTimestamp()
                });
                manualCaloriesInput.value = '';
                manualProteinInput.value = '';
                manualQuantityInput.value = '';
            } catch (e) {
                console.error("Error adding document: ", e);
            } finally {
                showLoading(false);
            }
        }

        async function searchFoodAndAutoAddMacros() {
            const foodName = searchFoodNameInput.value.trim();
            const quantity = evaluateMathExpression(searchFoodQuantityInput.value); // Evaluate quantity for search food

            if (!foodName) {
                console.error('Please enter a food name to search.');
                return;
            }
            if (quantity === null || quantity <= 0) {
                console.error('Quantity must be a positive number or valid math expression.');
                return;
            }

            if (NUTRITIONIX_APP_ID === "YOUR_NUTRITIONIX_APP_ID" || NUTRITIONIX_APP_KEY === "YOUR_NUTRITIONIX_APP_KEY") {
                console.error("Nutritionix API keys are not configured. Please get your keys from developer.nutritionix.com and replace the placeholders in the code.");
                return;
            }

            showLoading(true);

            try {
                const response = await fetch('https://trackapi.nutritionix.com/v2/natural/nutrients', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-app-id': NUTRITIONIX_APP_ID,
                        'x-app-key': NUTRITIONIX_APP_KEY
                    },
                    body: JSON.stringify({ query: foodName })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Nutritionix API error: ${response.status} ${response.statusText} - ${errorData.message || JSON.stringify(errorData)}`);
                }

                const data = await response.json();
                console.log("Nutritionix response:", data);

                if (data.foods && data.foods.length > 0) {
                    const firstFood = data.foods[0];
                    const protein = (firstFood.nf_protein || 0) * quantity; // Apply quantity
                    const calories = (firstFood.nf_calories || 0) * quantity; // Apply quantity
                    const foodDescription = `${foodName} (${searchFoodQuantityInput.value} = ${quantity.toFixed(2)}x)`; // Update description to show raw and evaluated quantity

                    if (db) {
                        await addDoc(collection(db, `artifacts/${appId}/users/${userId}/foodEntries`), {
                            name: foodDescription,
                            protein: protein,
                            calories: calories,
                            timestamp: serverTimestamp()
                        });
                    } else {
                        totalProteinConsumed += protein;
                        totalCaloriesConsumed += calories;
                        updateSummaryDisplay();
                    }
                    searchFoodNameInput.value = '';
                    searchFoodQuantityInput.value = '1'; // Reset quantity to 1
                } else {
                    console.error('No food items found for your search. Try a different query or manual entry.');
                }
            } catch (error) {
                console.error("Error searching food with Nutritionix:", error);
            } finally {
                showLoading(false);
            }
        }

        // New function: Add manual cardio entry
        async function addManualCardioEntry() {
            const distance = parseFloat(manualCardioDistanceInput.value) || 0;
            const caloriesBurned = parseFloat(manualCardioCaloriesBurnedInput.value) || 0;

            if (isNaN(distance) || distance < 0 || isNaN(caloriesBurned) || caloriesBurned < 0) {
                console.error('Validation Error: Distance and Calories Burned must be non-negative numbers.');
                return;
            }

            if (!db || !appId || !userId) {
                console.warn("Firestore db, appId, or userId not initialized. Cannot add manual cardio entry. Adding to local totals only.");
                totalDistance += distance;
                totalCaloriesBurned += caloriesBurned;
                updateSummaryDisplay();
                manualCardioDistanceInput.value = '';
                manualCardioCaloriesBurnedInput.value = '';
                return;
            }

            try {
                showLoading(true);
                await addDoc(collection(db, `artifacts/${appId}/users/${userId}/cardioEntries`), {
                    name: `Manual Cardio (${distance} miles)`,
                    distance: distance,
                    caloriesBurned: caloriesBurned,
                    timestamp: serverTimestamp()
                });
                manualCardioDistanceInput.value = '';
                manualCardioCaloriesBurnedInput.value = '';
            } catch (e) {
                console.error("Error adding manual cardio entry: ", e);
            } finally {
                showLoading(false);
            }
        }

        // New function: Search cardio and auto-add metrics (AI powered)
        async function searchCardioAndAutoAddMetrics() {
            const activityDescription = searchCardioInput.value.trim();

            if (!activityDescription) {
                console.error('Please describe your cardio activity.');
                return;
            }

            // YOUR GOOGLE CLOUD API KEY FOR GEMINI API
            const apiKey = "AIzaSyADS0DXiYSI4mcDxEfQ4pETNntHxyQwDrE"; // Replace with your actual Gemini API Key if you have one.

            if (!db && apiKey === "AIzaSyADS0DXiYSI4mcDxEfQ4pETNntHxyQwDrE") {
                console.warn("Firestore db not initialized AND AI search API key is missing/default. Cannot save search result or perform AI search.");
                return;
            }

            showLoading(true);

            try {
                // Construct prompt, including weight if available and emphasizing accurate calculation
                const weightInfo = currentWeight > 0 ? ` (assuming a body weight of ${currentWeight} lbs)` : '';
                const prompt = `Calculate the total distance (in miles) and estimate the calories burned for the activity: '${activityDescription}'${weightInfo}. Consider the following factors for calorie estimation: distance, pace, elevation gain, and a body weight of ${currentWeight} lbs. Use accurate scientific formulas or widely accepted methods for calorie expenditure for the given activity type. Provide the response in JSON format. If you cannot provide a precise value, give a reasonable estimate. If you cannot estimate, set distance and caloriesBurned to 0. Example: { "activity": "2.4 mile walk with 114ft elevation at 11:24 pace", "distance": 2.4, "caloriesBurned": 200 }`;
                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });

                const payload = {
                    contents: chatHistory,
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "OBJECT",
                            properties: {
                                "activity": { "type": "STRING" },
                                "distance": { "type": "NUMBER" },
                                "caloriesBurned": { "type": "NUMBER" }
                            },
                            required: ["activity", "distance", "caloriesBurned"]
                        }
                    }
                };

                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`LLM API error: ${response.status} ${response.statusText} - ${errorData.error ? errorData.error.message : 'Unknown error'}`);
                }

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const jsonString = result.candidates[0].content.parts[0].text;
                    const parsedMetrics = JSON.parse(jsonString);

                    if (parsedMetrics.distance !== undefined && parsedMetrics.caloriesBurned !== undefined) {
                        const finalDistance = parsedMetrics.distance;
                        const finalCaloriesBurned = parsedMetrics.caloriesBurned;

                        if (db) {
                            await addDoc(collection(db, `artifacts/${appId}/users/${userId}/cardioEntries`), {
                                name: parsedMetrics.activity || activityDescription,
                                distance: finalDistance,
                                caloriesBurned: finalCaloriesBurned,
                                timestamp: serverTimestamp()
                            });
                        } else {
                            totalDistance += finalDistance;
                            totalCaloriesBurned += finalCaloriesBurned;
                            updateSummaryDisplay();
                        }
                        searchCardioInput.value = '';
                    } else {
                        console.error('Could not get valid cardio metrics from AI. Please try manual entry.');
                    }
                } else {
                    console.error('AI could not estimate cardio metrics. Try manual entry.');
                }
            } catch (error) {
                console.error("Error searching cardio with AI:", error);
            } finally {
                showLoading(false);
            }
        }

        // Toggles the visibility of the custom preset food dropdown options
        function togglePresetDropdown() {
            presetDropdownOptions.classList.toggle('hidden');
            presetDropdownHeader.classList.toggle('open');
        }

        // Handles click on an individual preset food item in the custom dropdown
        function handlePresetFoodItemClick(event) {
            selectedPresetFood = JSON.parse(event.target.dataset.food);
            selectedPresetFoodNameDisplay.textContent = selectedPresetFood.name; // Update header
            presetDropdownOptions.classList.add('hidden'); // Hide dropdown options
            presetDropdownHeader.classList.remove('open'); // Reset header arrow
            openQuantityModal();
        }

        // Toggles visibility of the custom food input fields
        function toggleCustomFoodInput() {
            customPresetFoodInputs.classList.toggle('hidden');
            // The addCustomPresetFoodBtn's visibility is tied to customPresetFoodInputs, so no explicit toggle needed here for the button itself.
        }

        // Opens the quantity input modal
        function openQuantityModal() {
            if (selectedPresetFood) {
                document.getElementById('quantityModalTitle').textContent = `Enter Grams for ${selectedPresetFood.name}`;
                quantityInputGrams.value = ''; // Clear previous input
                quantityInputModal.classList.add('open');
            }
        }

        // Closes the quantity input modal
        function closeQuantityModal() {
            quantityInputModal.classList.remove('open');
            selectedPresetFoodNameDisplay.textContent = '-- Select Preset Food --'; // Reset dropdown header text
            selectedPresetFood = null; // Clear selected food
        }

        // Adds food based on grams from preset
        async function addGramsEntry() {
            const grams = evaluateMathExpression(quantityInputGrams.value);

            if (grams === null || grams <= 0) {
                console.error('Validation Error: Grams must be a positive number or valid math expression.');
                return;
            }

            if (!selectedPresetFood) {
                console.error("No preset food selected.");
                closeQuantityModal();
                return;
            }

            const { name, calories, protein, servingSize } = selectedPresetFood;

            if (servingSize <= 0) {
                console.error("Invalid serving size for selected preset food. Please edit preset or use manual entry.");
                closeQuantityModal();
                return;
            }

            const multiplier = grams / servingSize;
            const finalCalories = calories * multiplier;
            const finalProtein = protein * multiplier;

            if (!db || !appId || !userId) {
                console.warn("Firestore db, appId, or userId not initialized. Cannot add grams entry. Adding to local totals only.");
                totalProteinConsumed += finalProtein;
                totalCaloriesConsumed += finalCalories;
                updateSummaryDisplay();
                closeQuantityModal();
                return;
            }

            try {
                showLoading(true);
                await addDoc(collection(db, `artifacts/${appId}/users/${userId}/foodEntries`), {
                    name: `${name} (${grams}g)`,
                    protein: finalProtein,
                    calories: finalCalories,
                    timestamp: serverTimestamp()
                });
                closeQuantityModal();
            } catch (e) {
                console.error("Error adding grams entry:", e);
            } finally {
                showLoading(false);
            }
        }


        async function addCustomPresetFood() {
            const name = customPresetFoodInputs.querySelector('input[placeholder="Food Name"]').value.trim();
            const calories = parseFloat(customPresetCaloriesInput.value) || 0;
            const protein = parseFloat(customPresetProteinInput.value) || 0;
            const servingSize = parseFloat(customPresetServingSizeInput.value) || 0; // In grams

            if (!name || isNaN(calories) || calories < 0 || isNaN(protein) || protein < 0 || isNaN(servingSize) || servingSize <= 0) {
                console.error('Please enter a valid name, non-negative calories/protein, and a positive serving size for the custom preset food.');
                return;
            }

            if (!db || !appId || !userId) {
                console.warn("Firestore db, appId, or userId not initialized. Cannot add custom preset. Local operation only.");
                console.log("Adding custom preset locally (not persisted):", { name, calories, protein, servingSize });
                // Re-populate dropdown to show the new item locally if db is not available (for dev purposes)
                listenForPresetFoods(); // This will not work if db is truly not available, but useful during dev.
                customPresetFoodInputs.classList.add('hidden');
                return;
            }

            try {
                showLoading(true);
                await addDoc(collection(db, `artifacts/${appId}/users/${userId}/presetFoods`), {
                    name: name,
                    calories: calories,
                    protein: protein,
                    servingSize: servingSize,
                    timestamp: serverTimestamp()
                });
                // Clear fields and hide inputs
                customPresetFoodInputs.querySelector('input[placeholder="Food Name"]').value = '';
                customPresetCaloriesInput.value = '';
                customPresetProteinInput.value = '';
                customPresetServingSizeInput.value = '';
                customPresetFoodInputs.classList.add('hidden');
                selectedPresetFoodNameDisplay.textContent = '-- Select Preset Food --'; // Reset dropdown header text
            } catch (e) {
                console.error("Error adding custom preset food:", e);
            } finally {
                showLoading(false);
            }
        }


        function openSettingsModal() {
            settingsProteinGoalInput.value = currentProteinGoal;
            settingsCalorieGoalInput.value = currentCalorieGoal;
            settingsWeightInput.value = currentWeight; // Load current weight into settings
            settingsModal.classList.add('open');
        }

        function closeSettingsModal() {
            settingsModal.classList.remove('open');
        }

        async function saveSettings() {
            const newProteinGoal = parseFloat(settingsProteinGoalInput.value);
            const newCalorieGoal = parseFloat(settingsCalorieGoalInput.value);
            const newWeight = parseFloat(settingsWeightInput.value); // Get new weight

            if (isNaN(newProteinGoal) || newProteinGoal < 0 ||
                isNaN(newCalorieGoal) || newCalorieGoal < 0 ||
                isNaN(newWeight) || newWeight <= 0) { // Weight must be positive
                console.error('Please enter valid positive numbers for goals and weight.');
                return;
            }
            if (!db || !appId || !userId) {
                console.warn("Firestore db, appId, or userId not initialized. Cannot save settings. Updating local goals only.");
                currentProteinGoal = newProteinGoal;
                currentCalorieGoal = newCalorieGoal;
                currentWeight = newWeight;
                updateSummaryDisplay();
                settingsModal.classList.remove('open');
                return;
            }

            try {
                showLoading(true);
                const goalsDocRef = doc(db, `artifacts/${appId}/users/${userId}/goals/daily`);
                await setDoc(goalsDocRef, {
                    proteinGoal: newProteinGoal,
                    calorieGoal: newCalorieGoal,
                    weight: newWeight // Save weight
                }, { merge: true });
                settingsModal.classList.remove('open');
            } catch (e) {
                console.error("Error saving goals: ", e);
            } finally {
                showLoading(false);
            }
        }
    </script>
</head>
<body class="flex items-center justify-center min-h-screen p-4 sm:p-6 md:p-8">
    <div id="app-container" class="space-y-6">
        <h1 class="text-3xl font-bold text-center text-gray-800">Calorie Tracker</h1>

        <!-- Daily Summary Section -->
        <div class="bg-indigo-50 p-6 rounded-2xl shadow-md">
            <h2 class="section-title text-indigo-800">Daily Summary</h2>
            <div class="grid grid-cols-2 gap-4 text-center mb-4">
                <div>
                    <p class="text-gray-600 text-sm">Protein (g)</p>
                    <p class="text-xl font-semibold text-indigo-700"><span id="currentProteinDisplay">0</span> / <span id="proteinGoalDisplay">0</span></p>
                    <div class="progress-bar-container">
                        <div id="proteinProgressBar" class="progress-bar-fill"></div>
                    </div>
                    <p class="text-gray-600 text-sm mt-2">Left: <span id="proteinLeftDisplay" class="font-semibold">0</span>g</p>
                </div>
                <div>
                    <p class="text-gray-600 text-sm">Calories</p>
                    <p class="text-xl font-semibold text-indigo-700"><span id="currentCalorieDisplay">0</span> / <span id="calorieGoalDisplay">0</span></p>
                    <div class="progress-bar-container">
                        <div id="calorieProgressBar" class="progress-bar-fill"></div>
                    </div>
                    <p class="text-gray-600 text-sm mt-2">Left: <span id="caloriesLeftDisplay" class="font-semibold">0</span></p>
                </div>
            </div>

            <!-- Daily Cardio Summary -->
            <div class="grid grid-cols-2 gap-4 text-center mt-6">
                <div>
                    <p class="text-gray-600 text-sm">Distance (miles)</p>
                    <p class="text-xl font-semibold text-indigo-700"><span id="currentDistanceDisplay">0.0</span></p>
                    <p class="text-gray-600 text-sm mt-2">&nbsp;</p> <!-- Filler to align with "Left" text -->
                </div>
                <div>
                    <p class="text-gray-600 text-sm">Calories Burned</p>
                    <p class="text-xl font-semibold text-indigo-700"><span id="currentCaloriesBurnedDisplay">0</span></p>
                    <p class="text-gray-600 text-sm mt-2">&nbsp;</p> <!-- Filler to align with "Left" text -->
                </div>
            </div>

            <button id="openSettingsBtn" class="w-full secondary-button mt-4">Settings</button>
            <button id="resetDailyBtn" class="w-full secondary-button mt-2">Reset All Data for Today</button>
        </div>

        <!-- Add Food & Cardio Section -->
        <div class="space-y-6"> <!-- Container for the two new cards -->
            <!-- Add Food Box -->
            <div class="sub-section-card">
                <h2 class="section-title text-gray-800">Add Food</h2>
                <!-- Search Food (Nutritionix Powered) -->
                <div class="mb-6">
                    <h3 class="font-semibold text-gray-800 mb-2">Search & Auto-Add Food Macros</h3>
                    <div class="search-input-group search-input-group-row">
                        <input type="text" id="searchFoodName" placeholder="Search">
                        <input type="text" id="searchFoodQuantity" placeholder="Qty" value="1">
                        <button id="searchFoodBtn">Add Food</button>
                    </div>
                </div>

                <!-- Preset Food Selection -->
                <div>
                    <h3 class="font-semibold text-gray-800 mb-2">Select Preset Food</h3>
                    <!-- Custom Preset Food Dropdown -->
                    <div class="custom-dropdown-container">
                        <div id="presetDropdownHeader" class="custom-dropdown-header">
                            <span id="selectedPresetFoodName">-- Select Preset Food --</span>
                            <span class="dropdown-arrow">&#9660;</span>
                        </div>
                        <div id="presetDropdownOptions" class="custom-dropdown-options hidden">
                            <!-- Options will be dynamically populated by JavaScript -->
                        </div>
                    </div>
                    <button id="toggleCustomFoodInputBtn" class="w-full secondary-button mt-2 mb-4">Add Custom Preset Food</button>

                    <!-- Custom Preset Food Inputs (hidden by default, toggled by button) -->
                    <div id="customPresetFoodInputs" class="hidden space-y-3 mt-4">
                        <h3 class="font-semibold text-gray-800 mb-2">Define New Preset Food</h3>
                        <input type="text" placeholder="Food Name">
                        <input type="number" id="customPresetCalories" placeholder="Calories per serving">
                        <input type="number" id="customPresetProtein" placeholder="Protein (g) per serving">
                        <input type="number" id="customPresetServingSize" placeholder="Serving Size (grams)">
                        <button id="addCustomPresetFoodBtn" class="w-full">Add Custom Preset</button>
                    </div>

                    <!-- Manual Input Fields (always visible) -->
                    <div id="manualInputFields" class="mt-4">
                        <h3 class="font-semibold text-gray-800 mb-2">Manually Add Food Macros</h3>
                        <div class="manual-entry-grid mb-3">
                            <input type="number" id="manualCalories" placeholder="Calories">
                            <input type="number" id="manualProtein" placeholder="Protein (g)">
                            <input type="text" id="manualQuantity" placeholder="Qty (e.g., 1 or 22/18)" value="1">
                        </div>
                        <button id="addManualFoodBtn" class="w-full">Add Manual Food</button>
                    </div>
                </div>
            </div>

            <!-- Add Cardio Box -->
            <div class="sub-section-card">
                <h2 class="section-title text-gray-800">Add Cardio</h2>
                <!-- Search & Auto-Add Cardio (AI Powered) -->
                <div class="mb-6">
                    <h3 class="font-semibold text-gray-800 mb-2">Search & Auto-Add Cardio</h3>
                    <div class="search-input-group">
                        <input type="text" id="searchCardio" placeholder="Search">
                        <button id="searchCardioBtn">Add Cardio</button>
                    </div>
                </div>

                <!-- Manually Add Cardio -->
                <div>
                    <h3 class="font-semibold text-gray-800 mb-2">Manually Add Cardio</h3>
                    <div class="manual-entry-grid mb-3">
                        <input type="number" id="manualCardioDistance" placeholder="Distance (miles)">
                        <input type="number" id="manualCardioCaloriesBurned" placeholder="Calories Burned">
                    </div>
                    <button id="addManualCardioBtn" class="w-full">Add Manual Cardio</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal-overlay">
        <div class="modal-content">
            <button class="close-button" id="closeSettingsBtn">&times;</button>
            <h2 class="section-title text-gray-800 mb-4">Settings</h2>
            <div class="mb-4">
                <label for="settingsProteinGoal" class="block text-gray-700 text-sm font-bold mb-2">Protein Goal (g)</label>
                <input type="number" id="settingsProteinGoal" class="w-full" placeholder="e.g., 150">
            </div>
            <div class="mb-6">
                <label for="settingsCalorieGoal" class="block text-gray-700 text-sm font-bold mb-2">Calorie Goal</label>
                <input type="number" id="settingsCalorieGoal" class="w-full" placeholder="e.g., 2000">
            </div>
            <div class="mb-6">
                <label for="settingsWeight" class="block text-gray-700 text-sm font-bold mb-2">Weight (lbs)</label>
                <input type="number" id="settingsWeight" class="w-full" placeholder="e.g., 150">
            </div>
            <button id="saveSettingsBtn" class="w-full">Save Goals</button>
        </div>
    </div>

    <!-- Quantity Input Modal (New) -->
    <div id="quantityInputModal" class="modal-overlay">
        <div class="modal-content relative">
            <button class="close-button" id="closeQuantityModalBtn">&times;</button>
            <h2 id="quantityModalTitle" class="section-title text-gray-800 mb-4">Enter Grams</h2>
            <div class="mb-4">
                <label for="quantityInputGrams" class="block text-gray-700 text-sm font-bold mb-2">Grams Consumed</label>
                <input type="text" id="quantityInputGrams" class="w-full" placeholder="e.g., 150 or 22/18">
            </div>
            <button id="addGramsEntryBtn" class="w-full">Add to Daily Data</button>
        </div>
    </div>

    <!-- Message Box (Toast) - Styling kept, but no JS calls to show it -->
    <div id="messageBox" class="message-box"></div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner"></div>
    </div>
</body>
</html>
